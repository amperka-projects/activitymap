====== Карта офисной активности ======

{{ :projects:activitymap:assembled.jpg?direct&700 }}

===== Что это такое? =====

Сегодня мы разберёмся, как объединить дюжину ардуин в одну сеть и не пуститься по миру. Для выполнения этой сложнейшей задачи мы воспользуемся RS485-шилдами, которые позволяют развернуть сеть типа [[wpru>Шина_(топология_компьютерной_сети) | «общая шина»]]. Главным преимуществом такой сети является дешевизна развёртывания: вам не требуется прокладывать кабели к каждому узлу от маршрутизатора, да и сам этот маршрутизатор не требуется.
===== Что нам понадобится? =====

Ведущее устройство:
  - [[amp>product/arduino-leonardo | Arduino Leonardo]]
  - [[amp>product/arduino-rs485-shield | DF Robot RS485-шилд]]
  - [[amp>product/wall-plug-1a | Импульсный блок питания]]
  - [[amp>product/cables-wires | Кабель Micro USB]]

Ведомое устройство:
  - [[amp>product/arduino-uno | Arduino Uno]]
  - [[amp>product/arduino-rs485-shield | DFRobot RS485-шилд]]
  - [[amp>product/breadboard-mini | Breadboard Mini]]
  - [[amp>product/wire-mm | Провода «папа-папа»]]
  - [[amp>product/infrared-range-meter-150 | Инфракрасный дальномер Sharp (20-150 см) ×2 шт]]

Также для прокладки сети вам потребуется медный провод сечением 0,5..1 мм.
===== Как это собрать? =====

Для сборки ведущего устройства:

  - Установите RS485-шилд на Arduino Leonardo.
  - Подключите импульсный источник питания к Arduino Leonardo.
  - Подключите линии «A» и «B» сети RS485 к клеммнику.
  - Подключите линии «GND» и «VIN» сети RS485 к соответствующим выводам Arduino.
  - Подключите USB-кабелем плату Arduino к ПК.

Для сборки ведомого устройства:

  - Установите Troyka-шилд на Arduino Uno.
  - Установите RS485-шилд на Troyka-шилд.
  - Подключите дальномеры к аналоговым тройкам A0 и A1.
  - Подключите линии «A» и «B» сети RS485 к клеммнику.
  - Подключите линии «GND» и «VIN» сети RS485 к соответствующим выводам Arduino.

Прокладка сети:
  - Воспользуйтесь витой парой или скрутите два провода в витую пару при помощи шуруповёрта.
  - Протяните витую пару так, чтобы от неё до каждого из ваших устройств было расстояние не более 1 м.
  - Соедините каждое устройство с линией. Разрывать её не обязательно. Можно воспользоваться таким способом: <картинко> В итоге у вас должна получиться приблизительно такая сеть:{{ :projects:activitymap:scheme.png?direct&700 |}}
  - На всех платах установите переключатель выбора режима работы в ручной режим и включите передатчик (переключатель ON/OFF).

===== Исходный код =====

==== Визуализация на Processing ====

<code java activitymap.pde>
</code>
==== Ведущее устройство ====

<code cpp master.ino>
</code>

==== Ведомые устройства ====

<code cpp sensor.ino>
</code>

===== Как это работает? =====

Когда человек проходит через дверной проём, он сначала попадает в поле зрения одного датчика, а потом другого. По тому, какой датчик сработал первым, можно определить направление пересечения дверного проёма. Если мы подключимся к аналоговым пинам датчиков, то при проходе человека увидим примерно такую картину:

{{ :projects:activitymap:signals.png?direct}}

Всё, что выше Vref, скетч воспринимает как единицу. Остальное — как нули. Vref надо подбирать исходя из размеров дверных косяков и параметров датчиков.

Каждый узел хранит количество проходов. При обнаружении пересечения дверного проёма устройство добавляет «1» к переменной, если человек прошёл в одну сторону, и отнимает «1» в обратном случае.

Ведущее устройство циклически опрашивает все узлы, посылая пакет с номером устройства. Эти пакеты получают все ведомые устройства одновременно, однако отвечает только то устройство, номер которого указан в пакете. Номер устройства задаётся  выводами «8», «9», «10».

В ответном пакете устройство сообщает ведущему устройству значение хранимой переменной проходов. После этого устройство обнуляет это значение. Если между двумя опросами одного устройства было два прохода в разные стороны, то эти события могут «ускользнуть» от ведущего. Чтобы этого не произошло опрос производится очень часто — десятки раз в секунду.

Ведомые устройства никогда не начинают передачу по собственному желанию. Они только отвечают на запросы ведущего. Этим решается проблема [[wpru>Коллизия_кадров | коллизий]] на линии.

Ведущее устройство основано на [[amp>product/arduino-leonardo | Arduino Leonardo]]. Это позволяет использовать одновременно RS485-шилд и общение по Serial между Arduino и ПК. Данные, собраные со всех ведомых устройств, передаются по Serial, где их получает Processing-программа и отображает в графическом виде. Она рисует план помещений и отображает в каждой комнате количество находящихся там человек.

{{ :projects:activitymap:host_window.png?direct}}



===== Демонстрация работы устройства =====

{{youtube>eRLrCk5RlPs?large}}
===== Что можно сделать ещё? =====

  - В нашей реализации есть изъян: если опрос ведомого устройства будет происходить в момент прохода человека, то проход может остаться незамеченным. Чтобы избавиться от этого изъяна нужно подключать дальномеры через компараторы так, чтобы Arduino получала не аналоговый, а цифровой сигнал. Тогда на него можно будет назначить прерывание и обрабатывать события прохода по прерываниям.
